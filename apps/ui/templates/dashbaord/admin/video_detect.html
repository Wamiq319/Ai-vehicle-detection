{% extends "dashbaord/admin/base_admin.html" %} {% block content %}

<!-- Messages -->
{% if messages %}
<div class="mb-6">
  {% for message in messages %}
  <div
    class="p-4 rounded-lg {% if message.tags == 'success' %}bg-green-100 text-green-800 border border-green-200{% elif message.tags == 'error' %}bg-red-100 text-red-800 border border-red-200{% else %}bg-blue-100 text-blue-800 border border-blue-200{% endif %}"
  >
    {{ message }}
  </div>
  {% endfor %}
</div>
{% endif %}

<!-- Existing Toll Rate Section -->
<div class="max-w-3xl mx-auto bg-white rounded-2xl shadow p-8 mb-10">
  <div class="flex justify-between items-center mb-6">
    <h2 class="text-2xl font-bold text-blue-800 flex items-center gap-2">
      <span>ğŸš¦</span> Toll Rates
    </h2>
  </div>

  <div id="rates-display" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
    {% for vehicle, rate in rates.items %}
    <div
      class="bg-blue-50 rounded-lg p-6 border border-blue-200 flex flex-col items-center"
    >
      <span class="text-5xl mb-2">
        {% if vehicle == 'car' %}ğŸš—
        {% elif vehicle == 'truck' %}ğŸš›
        {% elif vehicle == 'bus' %}ğŸšŒ
        {% elif vehicle == 'van' %}ğŸš
        {% elif vehicle == 'motorbike' %}ğŸï¸
        {% elif vehicle == 'threewheel' %}ğŸ›º
        {% else %}â“
        {% endif %}
      </span>
      <h3 class="text-lg font-bold text-blue-800 mb-2">{{ vehicle|title }}</h3>
      <p class="text-2xl font-bold text-gray-900">
        <span class="text-lg font-semibold">RS</span>{{ rate }}
      </p>
    </div>
    {% endfor %}
  </div>
</div>

<!-- Video Upload & Stream Section -->
<div class="max-w-3xl mx-auto bg-white rounded-2xl shadow p-8">
  <h2 class="text-2xl font-bold text-blue-800 flex items-center gap-2 mb-6">
    <span>ğŸ“¹</span> Vehicle Detection Input
  </h2>

  <!-- Upload Video -->
  <form
    method="POST"
    action="{% url 'detections:upload_video' %}"
    enctype="multipart/form-data"
    class="mb-8"
  >
    {% csrf_token %}
    <div
      class="flex flex-col items-center border-2 border-dashed border-blue-300 rounded-xl p-6 hover:bg-blue-50 transition"
    >
      <input
        type="file"
        name="video_file"
        accept="video/*"
        class="hidden"
        id="video-input"
        required
      />
      <label
        for="video-input"
        class="cursor-pointer text-blue-700 font-semibold"
      >
        â¬†ï¸ Click to Upload Video
      </label>
      <p class="text-sm text-gray-500 mt-2">Supported formats: MP4, AVI, MOV</p>
      <video
        id="video-preview"
        class="mt-4 w-full rounded-lg border hidden"
        controls
      ></video>
    </div>

    <div class="flex justify-end mt-6">
      <button
        type="submit"
        class="px-6 py-3 bg-blue-700 text-white rounded-lg shadow hover:bg-blue-800 transition"
      >
        ğŸš€ Process Video
      </button>
    </div>
  </form>

  <!-- Connect Live Stream -->
  <div
    class="flex flex-col items-center border border-blue-200 rounded-xl p-6 bg-blue-50"
  >
    <span class="text-5xl mb-3">ğŸ¥</span>
    <h3 class="text-lg font-bold text-blue-800 mb-3">Connect Live Stream</h3>
    <p class="text-gray-600 mb-4 text-center">
      This option will allow you to connect a CCTV or live camera stream for
      real-time vehicle detection.
    </p>
    <video id="live-stream" class="mt-4 w-full rounded-lg border hidden" autoplay playsinline></video>
    <button
      type="button"
      id="connect-stream-btn"
      class="px-6 py-3 bg-green-600 text-white rounded-lg shadow hover:bg-green-700 transition mt-4"
    >
      ğŸ”— Connect Now
    </button>
  </div>
</div>

<!-- Loading Overlay -->
<div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex flex-col items-center justify-center z-50 hidden">
  <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-32 w-32 mb-4"></div>
  <h2 class="text-center text-white text-xl font-semibold">Processing Video...</h2>
  <p class="w-1/3 text-center text-white">This may take a moment. Please don't close this page.</p>
  <button id="cancel-upload-btn" class="mt-6 px-6 py-3 bg-red-600 text-white rounded-lg shadow hover:bg-red-700 transition">
    Cancel
  </button>
</div>

<style>
  .loader {
    border-top-color: #3498db;
    -webkit-animation: spinner 1.5s linear infinite;
    animation: spinner 1.5s linear infinite;
  }

  @-webkit-keyframes spinner {
    0% { -webkit-transform: rotate(0deg); }
    100% { -webkit-transform: rotate(360deg); }
  }

  @keyframes spinner {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
</style>

<script>
  (function () {
    const input = document.getElementById("video-input");
    const preview = document.getElementById("video-preview");
    if (input && preview) {
      input.addEventListener("change", () => {
        const file = input.files && input.files[0];
        if (file) {
          const url = URL.createObjectURL(file);
          preview.src = url;
          preview.classList.remove("hidden");
        } else {
          preview.src = "";
          preview.classList.add("hidden");
        }
      });
    }

    const connectBtn = document.getElementById("connect-stream-btn");
    const liveStream = document.getElementById("live-stream");
    let stream;

    if (connectBtn && liveStream) {
      connectBtn.addEventListener("click", async () => {
        if (stream) {
          stream.getTracks().forEach(track => track.stop());
          liveStream.srcObject = null;
          liveStream.classList.add("hidden");
          stream = null;
          connectBtn.textContent = 'ğŸ”— Connect Now';
        } else {
          try {
            stream = await navigator.mediaDevices.getUserMedia({ video: true });
            liveStream.srcObject = stream;
            liveStream.classList.remove("hidden");
            connectBtn.textContent = 'ğŸ›‘ Disconnect';
          } catch (err) {
            console.error("Error accessing webcam: ", err);
            alert("Could not access the webcam. Please ensure you have a webcam and have granted permission.");
          }
        }
      });
    }

    const uploadForm = document.querySelector('form[enctype="multipart/form-data"]');
    const loadingOverlay = document.getElementById('loading-overlay');
    const cancelUploadBtn = document.getElementById('cancel-upload-btn');
    const allButtons = document.querySelectorAll('button');
    const allInputs = document.querySelectorAll('input');

    if (uploadForm && loadingOverlay) {
      uploadForm.addEventListener('submit', function(event) {
        const videoInput = document.getElementById('video-input');
        if (videoInput.files.length > 0) {
          loadingOverlay.classList.remove('hidden');
          allButtons.forEach(button => button.disabled = true);
          allInputs.forEach(input => {
            if (input.name !== 'csrfmiddlewaretoken' && input.name !== 'video_file') {
              input.disabled = true;
            }
          });
          if(cancelUploadBtn) cancelUploadBtn.disabled = false;
        } else {
          event.preventDefault();
          alert("Please select a video file to upload.");
        }
      });
    }

    if (cancelUploadBtn) {
      cancelUploadBtn.addEventListener('click', function() {
        window.location.reload();
      });
    }
  })();
</script>

{% endblock %}
